// --------------------------------------------
// DATABASE SETUP
// --------------------------------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------
// MODELS
// --------------------------------------------

// 1️⃣ Profiles (Linked with Supabase Auth)
model Profile {
  id         String   @id @default(uuid())
  userId     String   @unique // from Supabase auth.users.id
  fullName   String?
  email      String?  @unique
  avatarUrl  String?
  bio        String?
  skills     String[] @default([])
  interests  String[] @default([])
  role       Role     @default(SEEKER)
  department String?
  year       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  jobs          Job[]          @relation("UserJobs")
  applications  Application[]
  bookmarks     Bookmark[]
  messagesSent  Message[]      @relation("MessagesSent")
  messagesRecv  Message[]      @relation("MessagesReceived")
  notifications Notification[]
  JobAnalytics  JobAnalytics[]

  @@index([userId])
}

// 2️⃣ Jobs (Finder Posts)
model Job {
  id                String    @id @default(uuid())
  title             String
  type              JobType
  description       String
  requirements      String? // Skills/requirements
  duration          String? // Timeline/duration
  compensation      String? // Payment/rewards (optional)
  location          String? // Remote/On-campus/Hybrid
  teamSize          String? // Team size needed
  tags              String[]
  status            JobStatus @default(PENDING) // Approval status
  isDraft           Boolean   @default(true) // Default to draft
  isFilled          Boolean   @default(false) // Mark when position filled
  isPublished       Boolean   @default(false) // Published status
  views             Int       @default(0)
  applicationsCount Int       @default(0)
  rejectionReason   String? // Reason if rejected by admin
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  publishedAt       DateTime? // When it was published
  approvedAt        DateTime? // When admin approved
  approvedBy        String? // Admin who approved

  // Relations
  createdById  String
  createdBy    Profile        @relation("UserJobs", fields: [createdById], references: [id])
  applications Application[]
  analytics    JobAnalytics[]
  bookmarks    Bookmark[]
  Message      Message[]

  @@index([createdById])
  @@index([type])
  @@index([status])
  @@index([isPublished, isFilled])
}

// 3️⃣ Applications (Seeker applies to Finder jobs)
model Application {
  id          String            @id @default(uuid())
  jobId       String
  applicantId String
  status      ApplicationStatus @default(PENDING)
  message     String?
  resumeUrl   String?
  matchScore  Int?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  job       Job     @relation(fields: [jobId], references: [id])
  applicant Profile @relation(fields: [applicantId], references: [id])

  @@unique([jobId, applicantId])
}

// 4️⃣ Messages (Real-time Chat)
model Message {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  jobId      String?
  content    String
  createdAt  DateTime @default(now())
  read       Boolean  @default(false)

  sender   Profile @relation("MessagesSent", fields: [senderId], references: [id])
  receiver Profile @relation("MessagesReceived", fields: [receiverId], references: [id])
  job      Job?    @relation(fields: [jobId], references: [id])
}

// 5️⃣ Bookmarks (Saved Jobs)
model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  jobId     String
  createdAt DateTime @default(now())

  user Profile @relation(fields: [userId], references: [id])
  job  Job     @relation(fields: [jobId], references: [id])

  @@unique([userId, jobId])
}

// 6️⃣ Job Analytics (View Tracking)
model JobAnalytics {
  id       String   @id @default(uuid())
  jobId    String
  userId   String
  viewedAt DateTime @default(now())

  job  Job     @relation(fields: [jobId], references: [id])
  user Profile @relation(fields: [userId], references: [id])

  @@unique([jobId, userId])
}

// 7️⃣ Notifications (In-App or Push)
model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user Profile @relation(fields: [userId], references: [id])
}

// --------------------------------------------
// ENUMS
// --------------------------------------------

enum Role {
  FINDER
  SEEKER
}

enum JobType {
  ACADEMIC_PROJECT // Academic Projects
  STARTUP_COLLABORATION // Startup/Collaborations
  PART_TIME_JOB // Part-time Jobs
  COMPETITION_HACKATHON // Competitions/Hackathons Teams Search
}

enum ApplicationStatus {
  PENDING
  SHORTLISTED
  ACCEPTED
  REJECTED
}

enum JobStatus {
  PENDING // Waiting for admin approval
  APPROVED // Approved by admin and can be published
  REJECTED // Rejected by admin
  POSTED // Approved and published
}
